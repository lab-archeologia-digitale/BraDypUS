/**
 * @author      Julian Bogdani <jbogdani@gmail.com>
 * @copyright    BraDypUS, Julian Bogdani <jbogdani@gmail.com>
 * @license      See file LICENSE distributed with this code
 */
var geoface={geoJSON:{},metadata:{},map:{},param:{},overlay:{},init:function(e,a){if(!($("#map").length>0))return geoface.queue=["getData","loadLeaflet","loadLDraw","loadLOmnivore","loadGoogle","loadGoogleMutant","buildMap"],geoface.param.tb=e,geoface.param.obj_encoded=a,geoface.runQueue(),this;core.message(core.tr("map_already_opened"))},runQueue:function(){var e=geoface.queue[0];geoface.queue.splice(0,1),void 0!==geoface[e]&&geoface[e]()},getData:function(){core.getJSON("geoface_ctrl","getGeoJson",{tb:geoface.param.tb,obj_encoded:geoface.param.obj_encoded},!1,(function(e){"error"!==e.status?("warning"===e.status&&core.message(core.tr("no_geodata_present_create"),"warning",!0),geoface.geoJSON=e.data,geoface.metadata=e.metadata,geoface.runQueue()):core.message(e.text,"error",!0)}))},loadGoogle:function(){if(void 0===geoface.metadata.gmapskey)return console.log("*** GoogleMaps key missing: if you want to use google layers please enter the key for table "+geoface.metadata.tb),void geoface.runQueue();"undefined"==typeof google?(console.log("Google load"),$.getScript("https://maps.googleapis.com/maps/api/js?key="+geoface.metadata.gmapskey,(function(){geoface.runQueue()})).fail((function(e,a,o){console.log("google",o)}))):geoface.runQueue()},loadGoogleMutant:function(){"undefined"!=typeof google&&void 0===L.GridLayer.GoogleMutant?$.getScript("./modules/geoface/leaflet-googleMutant/Leaflet.GoogleMutant.js",(function(){geoface.runQueue()})).fail((function(e,a,o){console.log("googleMutant",o)})):geoface.runQueue()},loadLeaflet:function(){$("head").find('link[href="./modules/geoface/leaflet/leaflet.css"]').length<1&&$("head").append($("<link />").attr({type:"text/css",rel:"stylesheet",href:"./modules/geoface/leaflet/leaflet.css"})),"undefined"==typeof L?$.getScript("./modules/geoface/leaflet/leaflet.js",(function(){L.Icon.Default.imagePath="./modules/geoface/leaflet/images/",geoface.runQueue()})).fail((function(e,a,o){console.log("L",o)})):geoface.runQueue()},loadLDraw:function(){$("head").find('link[href="./modules/geoface/leaflet-draw/leaflet.draw.css"]').length<1&&$("head").append($("<link />").attr({type:"text/css",rel:"stylesheet",href:"./modules/geoface/leaflet-draw/leaflet.draw.css"})),void 0===L.drawVersion?$.getScript("./modules/geoface/leaflet-draw/leaflet.draw.js",(function(){geoface.runQueue()})).fail((function(e,a,o){console.log("L.Draw",o)})):geoface.runQueue()},loadLOmnivore:function(){"undefined"==typeof omnivore?$.getScript("./modules/geoface/leaflet-omnivore/leaflet-omnivore.min.js",(function(){geoface.runQueue()})).fail((function(e,a,o){console.log("Omnivore",o)})):geoface.runQueue()},buildMap:function(){core.open({html:'<div id="map_container"><div id="map"></div></div>',unique:!0,title:core.tr("GeoFace"),loaded:function(){geoface.startL(),$(window).on("resize",(function(){geoface.resize()}))}})},startL:function(){geoface.map=new L.map("map");var e={OSM:new L.tileLayer("https://{s}.tile.osm.org/{z}/{x}/{y}.png").addTo(geoface.map),AWMC:L.tileLayer("https://{s}.tiles.mapbox.com/v3/isawnyu.map-knmctlkh/{z}/{x}/{y}.png"),"Imperium/DARE":L.tileLayer("https://dh.gu.se/tiles/imperium/{z}/{x}/{y}.png")};void 0!==L.gridLayer.googleMutant&&(e["Google Satellite"]=L.gridLayer.googleMutant({type:"satellite"}),e["Google Roadmap"]=L.gridLayer.googleMutant({type:"roadmap"}),e["Google Terrain"]=L.gridLayer.googleMutant({type:"terrain"}),e["Google Hybrid"]=L.gridLayer.googleMutant({type:"hybrid"}));var a={};for(var o in e)e.hasOwnProperty(o)&&(a[o]=e[o]);if(geoface.overlay[geoface.metadata.tb]=L.geoJson(geoface.geoJSON,{pointToLayer:function(e,a){return new L.CircleMarker(a,{color:"#f00",fillColor:"#ff0",weight:4,opacity:.7,radius:7})},onEachFeature:function(e,a){var o="";$.each(e.properties,(function(e,a){"id"!==e&&"geo_id"!==e&&(o+=e+": <strong>"+a+"</strong><br />")})),o+='<span class="btn btn-info btn-xs" onclick="api.record.read(\''+geoface.metadata.tb_id+"', ["+e.properties.id+'])">'+core.tr("read")+"</span>",a.bindPopup(o)}}).addTo(geoface.map),void 0!==geoface.metadata.local_layers&&"undefined"!=typeof omnivore&&$.each(geoface.metadata.local_layers,(function(e,a){const o=a.ext,t=a.name,n=a.full_path;switch(a.ext){case"csv":case"gpx":case"kml":case"wkt":case"topojson":case"geojson":geoface.overlay[t]=omnivore[o](n,null,L.geoJson(null,{onEachFeature:function(e,a){var o="";$.each(e.properties,(function(e,a){a&&(o+=e+": <strong>"+a+"</strong><br />")})),a.bindPopup(o)}})).addTo(geoface.map);break;default:console.log("Unknown extension: "+o)}})),geoface.map.addControl(new L.Control.Layers(a,geoface.overlay,{})),geoface.metadata.canUserEdit&&void 0!==L.Control.Draw){var t=new L.Control.Draw({draw:{marker:!1},edit:{featureGroup:geoface.overlay[geoface.metadata.tb]}});geoface.map.addControl(t),geoface.editListeners(geoface.overlay[geoface.metadata.tb])}geoface.resize(),void 0===geoface.overlay[geoface.metadata.tb]||$.isEmptyObject(geoface.overlay[geoface.metadata.tb]._layers)?geoface.map.setView([38.82259,-2.8125],3):geoface.map.fitBounds(geoface.overlay[geoface.metadata.tb].getBounds())},editListeners:function(e){geoface.map.on("draw:created",(function(a){api.link.add_ui((function(o,t,n){core.getJSON("geoface_ctrl","saveNew",!1,{tb:o,id:t,coords:geoface.toWKT(a.layer)},(function(e){core.message(e.text,e.value),a.layer.feature={properties:{geo_id:e.id}}})),$("#modal").modal("hide"),e.addLayer(a.layer)}),!1,!0,geoface.metadata.tb_id)})),geoface.map.on("draw:edited",(function(e){var a=[];e.layers.eachLayer((function(e){a.push({id:e.feature.properties.geo_id,coords:geoface.toWKT(e)})})),core.getJSON("geoface_ctrl","update",!1,{geodata:a},(function(e){core.message(e.text,e.status)}))})),geoface.map.on("draw:deleted",(function(e){var a=[];e.layers.eachLayer((function(e){a.push(e.feature.properties.geo_id)})),core.open({html:"<h2>"+core.tr("confirm_erase_feature")+"</h2>",title:core.tr("attention"),buttons:[{text:core.tr("erase"),click:function(){core.getJSON("geoface_ctrl","erase",!1,{ids:a},(function(e){core.message(e.text,e.status),layout.dialog.close()}))}},{text:core.tr("cancel"),action:"close"}]},"modal")}))},resize:function(){$("#map_container").css({width:"100%",height:$(window).height()-70}),$("#map").css({height:"100%"}),geoface.map.invalidateSize()},toWKT:function(e){var a,o,t=[];if(e instanceof L.Polygon||e instanceof L.Polyline){for(var n=e.getLatLngs(),r=0;r<n.length;r++)t.push(n[r].lng+" "+n[r].lat),0===r&&(a=n[r].lng,o=n[r].lat);if(e instanceof L.Polygon)return"POLYGON(("+t.join(",")+","+a+" "+o+"))";if(e instanceof L.Polyline)return"LINESTRING("+t.join(",")+")"}else if(e instanceof L.Marker||e instanceof L.CircleMarker)return"POINT("+e.getLatLng().lng+" "+e.getLatLng().lat+")"}};